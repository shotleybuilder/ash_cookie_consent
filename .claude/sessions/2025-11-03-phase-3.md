# ash_cookie_consent - Phase 3: Integration Layer

**Filename**: `2025-11-03-phase-3.md`

## Session Overview

**Start Time**: 2025-11-03

Implementing the Phoenix integration layer for ash_cookie_consent. This phase connects the UI components (Phase 2) with Phoenix applications through Plugs and LiveView hooks.

## Phase 1 & 2 Recap

**Phase 1** ✅ COMPLETED
- Core Ash resource `ConsentSettings` with GDPR-compliant attributes
- Custom actions (grant_consent, revoke_consent, active_consents)
- Domain configuration
- Clean compilation

**Phase 2** ✅ COMPLETED
- ConsentModal and ConsentScript Phoenix Components
- AlpineJS integration for interactivity
- Cookie groups configuration system
- Helper functions (consent_given?, has_consent?, etc.)
- 58 passing tests
- Comprehensive documentation

**Git Status**: 5 commits, latest: `8f6e859` - Phase 2 complete

## Phase 3 Goals

Build the integration layer to connect the library with Phoenix applications:

1. **Phoenix Plug** for traditional controller-based apps
2. **LiveView Hook** for LiveView-based apps
3. **Three-tier storage** implementation (cookie/session/database)
4. **Consent sync logic** for login/logout flows
5. **Form handler** for processing consent submissions

## Implementation Checklist

### 3.1 Phoenix Plug for Traditional Controllers

**3.1.1 Create AshCookieConsent.Plug**
- [ ] Create `lib/ash_cookie_consent/plug.ex`
- [ ] Implement `init/1` callback
  - [ ] Accept `:resource` option (Ash resource module)
  - [ ] Accept `:cookie_name` option (default: "_consent")
  - [ ] Accept `:session_key` option (default: "consent")
- [ ] Implement `call/2` callback
  - [ ] Read consent from cookie
  - [ ] Parse JSON consent data
  - [ ] Store in session for performance
  - [ ] Set `assigns.consent`
  - [ ] Set `assigns.show_consent_modal` (true if no consent)
  - [ ] For authenticated users: sync with database
- [ ] Handle cookie encryption/signing
- [ ] Error handling for malformed cookies

**3.1.2 Cookie Management**
- [ ] Create `lib/ash_cookie_consent/cookie.ex`
- [ ] `encode_consent/1` - Serialize consent to JSON
- [ ] `decode_consent/1` - Deserialize consent from JSON
- [ ] `set_consent_cookie/3` - Set cookie on conn
- [ ] `get_consent_cookie/1` - Read cookie from conn
- [ ] `delete_consent_cookie/1` - Remove cookie
- [ ] Handle cookie options (max_age, secure, http_only, same_site)

**3.1.3 Database Sync**
- [ ] `sync_consent_to_db/2` - Save consent to Ash resource
- [ ] `load_consent_from_db/1` - Load consent for user
- [ ] Handle user_id from conn.assigns
- [ ] Merge cookie consent with DB consent on login
- [ ] Update cookie from DB on login

### 3.2 LiveView Hook

**3.2.1 Create AshCookieConsent.LiveView.Hook**
- [ ] Create `lib/ash_cookie_consent/live_view/hook.ex`
- [ ] Implement `on_mount/4` callback
- [ ] Read consent from session (already set by Plug)
- [ ] Assign to socket (`socket.assigns.consent`)
- [ ] Set `show_consent_modal` flag
- [ ] Support different mount phases (:load_consent, :require_consent)

**3.2.2 LiveView Event Handlers**
- [ ] Create `lib/ash_cookie_consent/live_view/consent_live.ex` (example)
- [ ] Handle "update_consent" event
- [ ] Handle "accept_all" event
- [ ] Handle "reject_all" event
- [ ] Update session and cookie
- [ ] Broadcast consent changes to other LiveViews (optional)

### 3.3 Three-Tier Storage Implementation

**3.3.1 Storage Hierarchy**
```
Priority (read):
1. Socket/Conn assigns (fastest, request-scoped)
2. Session (fast, server-side)
3. Cookie (medium, client-side)
4. Database (slower, persistent, audit trail)

Priority (write):
1. Database (if authenticated)
2. Cookie (always)
3. Session (always)
4. Assigns (always)
```

**3.3.2 Storage Module**
- [ ] Create `lib/ash_cookie_consent/storage.ex`
- [ ] `get_consent/2` - Read from assigns → session → cookie → db
- [ ] `put_consent/3` - Write to all tiers
- [ ] `delete_consent/1` - Remove from all tiers
- [ ] Handle race conditions and conflicts

### 3.4 Consent Sync Logic

**3.4.1 Login Flow**
- [ ] Detect user login (user_id added to session)
- [ ] Load consent from database for user
- [ ] If DB consent exists:
  - [ ] Update cookie with DB consent
  - [ ] Prefer DB consent over cookie
- [ ] If cookie consent exists but no DB consent:
  - [ ] Save cookie consent to DB
  - [ ] Associate with user
- [ ] Merge strategy for conflicts

**3.4.2 Logout Flow**
- [ ] Keep cookie consent (for subsequent logins)
- [ ] Clear session consent
- [ ] Don't delete database records

**3.4.3 Consent Update Flow**
- [ ] User updates consent via modal
- [ ] Update cookie immediately
- [ ] Update session
- [ ] If authenticated: update database
- [ ] Validate consent data
- [ ] Set expires_at to 365 days from now

### 3.5 Form Handler

**3.5.1 Create Consent Controller**
- [ ] Create `lib/ash_cookie_consent/consent_controller.ex`
- [ ] `handle_consent/2` action
  - [ ] Parse form params (terms, groups)
  - [ ] Validate consent data
  - [ ] Create/update Ash resource
  - [ ] Set cookie
  - [ ] Update session
  - [ ] Redirect back or to specified URL

**3.5.2 LiveView Form Handler**
- [ ] Example LiveView event handler
- [ ] Parse consent params
- [ ] Update storage tiers
- [ ] Close modal (set show_consent_modal: false)

### 3.6 Configuration

**3.6.1 Application Config**
- [ ] Document config options in `config.ex`
  ```elixir
  config :ash_cookie_consent,
    cookie_name: "_consent",
    cookie_max_age: 365 * 24 * 60 * 60, # 1 year
    session_key: "consent",
    require_consent: false, # Block until consent given
    default_consent_url: "/consent"
  ```

**3.6.2 Per-Plug Configuration**
- [ ] Allow overriding global config
- [ ] Resource-specific configuration
- [ ] Custom cookie options

### 3.7 Testing

**3.7.1 Plug Tests**
- [ ] Test plug initialization
- [ ] Test consent loading from cookie
- [ ] Test consent loading from database
- [ ] Test assigns set correctly
- [ ] Test malformed cookie handling
- [ ] Test anonymous user flow
- [ ] Test authenticated user flow

**3.7.2 LiveView Hook Tests**
- [ ] Test on_mount callback
- [ ] Test consent assigned to socket
- [ ] Test show_consent_modal flag
- [ ] Test different mount phases

**3.7.3 Storage Tests**
- [ ] Test three-tier hierarchy
- [ ] Test get_consent prioritization
- [ ] Test put_consent writes all tiers
- [ ] Test conflict resolution

**3.7.4 Sync Tests**
- [ ] Test login sync (cookie → db)
- [ ] Test login sync (db → cookie)
- [ ] Test logout behavior
- [ ] Test consent update flow

**3.7.5 Integration Tests**
- [ ] Test full flow: anonymous → consent → login → persist
- [ ] Test full flow: login → load consent → update
- [ ] Test cookie expiration
- [ ] Test consent version changes

### 3.8 Documentation

**3.8.1 Module Documentation**
- [ ] Add @moduledoc to Plug
- [ ] Add @moduledoc to LiveView.Hook
- [ ] Add @moduledoc to Storage
- [ ] Add @moduledoc to Cookie
- [ ] Include usage examples in all modules

**3.8.2 Integration Guide**
- [ ] Update README with Plug usage
- [ ] Update README with LiveView Hook usage
- [ ] Add migration guide
- [ ] Add troubleshooting section
- [ ] Document three-tier storage pattern

**3.8.3 Examples**
- [ ] Create example controller
- [ ] Create example LiveView
- [ ] Create example layout template
- [ ] Add to examples/ directory

## Design Decisions

### Plug vs LiveView Hook

**Why both?**
- Traditional Phoenix apps use controllers → need Plug
- Modern Phoenix apps use LiveView → need Hook
- Both can coexist in same app
- Plug sets session, Hook reads session

**Flow:**
```
Request → Plug (sets session + assigns) → LiveView (on_mount reads session)
```

### Cookie Strategy

**Cookie Contents:**
```json
{
  "terms": "v1.0",
  "groups": ["essential", "analytics"],
  "consented_at": "2025-11-03T12:00:00Z",
  "expires_at": "2026-11-03T12:00:00Z"
}
```

**Cookie Security:**
- Signed (prevents tampering)
- HttpOnly: false (JavaScript needs to read for some scripts)
- Secure: true (in production)
- SameSite: Lax (CSRF protection)

### Database Sync Strategy

**On Login:**
1. Check if user has DB consent
2. If yes: DB is source of truth → update cookie
3. If no: Cookie is source of truth → save to DB

**On Consent Update:**
1. Update cookie immediately (fast UX)
2. Update DB if authenticated (audit trail)
3. Session updated automatically

**Conflict Resolution:**
- DB always wins on login
- Most recent consent wins on conflicts
- Check `consented_at` timestamp

### Session Storage

**Why Session?**
- Avoid database roundtrip on every request
- Faster than cookie parsing
- Server-side, can't be tampered with

**Session Contents:**
```elixir
%{
  "consent" => %{
    terms: "v1.0",
    groups: ["essential", "analytics"],
    consented_at: ~U[2025-11-03 12:00:00Z],
    expires_at: ~U[2026-11-03 12:00:00Z]
  }
}
```

## Technical Notes

### Plug Pipeline

```elixir
pipeline :browser do
  plug :accepts, ["html"]
  plug :fetch_session
  plug :fetch_flash
  plug :protect_from_forgery
  plug :put_secure_browser_headers
  plug AshCookieConsent.Plug, resource: MyApp.Consent.ConsentSettings
end
```

### LiveView Hook

```elixir
defmodule MyAppWeb do
  def live_view do
    quote do
      use Phoenix.LiveView
      on_mount {AshCookieConsent.LiveView.Hook, :load_consent}
    end
  end
end
```

### Form Submission

**Traditional Controller:**
```elixir
<form action="/consent" method="post">
  <input type="hidden" name="_csrf_token" value={@csrf_token} />
  <input type="hidden" name="terms" value="v1.0" />
  <input type="hidden" name="groups" value={Jason.encode!(["essential", "analytics"])} />
  <button type="submit">Save Preferences</button>
</form>
```

**LiveView Event:**
```elixir
<button phx-click="update_consent" phx-value-groups={Jason.encode!(["essential", "analytics"])}>
  Save Preferences
</button>
```

## Success Criteria

- [ ] Plug correctly loads consent and sets assigns
- [ ] LiveView Hook correctly loads consent to socket
- [ ] Cookie encoding/decoding works correctly
- [ ] Database sync works on login
- [ ] Consent updates persist across all storage tiers
- [ ] Tests passing (target: >40 new tests)
- [ ] Documentation complete with integration examples
- [ ] Code formatted and linted
- [ ] Example app demonstrates full flow

## Next Phase

**Phase 4: Testing & Polish**
- Comprehensive integration tests
- Example Phoenix application
- Performance optimization
- Error handling improvements
- Documentation polish

## Progress Log

### Session Start (2025-11-03)

**Starting Phase 3 implementation...**

### Core Integration Layer Complete (2025-11-03)

**Phase 3.1-3.2: Integration Modules - ✅ IMPLEMENTED**

#### Files Created

1. **lib/ash_cookie_consent/cookie.ex**
   - Cookie encoding/decoding to JSON
   - Cookie setting/getting/deleting
   - DateTime serialization for ISO8601 format
   - Configurable cookie options (name, max_age, secure, http_only, same_site)
   - Default 1-year expiration

2. **lib/ash_cookie_consent/storage.ex**
   - Three-tier storage hierarchy implementation
   - Read priority: Assigns → Session → Cookie → Database
   - Write to all applicable tiers
   - Sync functions for login/logout flows
   - Graceful handling of missing tiers

3. **lib/ash_cookie_consent/plug.ex**
   - Phoenix Plug for traditional controllers
   - Automatic consent loading from storage
   - Sets assigns (:consent, :show_consent_modal, :cookie_groups)
   - Handles anonymous and authenticated users
   - Cookie/session synchronization

4. **lib/ash_cookie_consent/live_view/hook.ex**
   - LiveView on_mount hook
   - Two mount phases: :load_consent, :require_consent
   - Socket assign management
   - Event handlers for consent updates
   - JavaScript cookie update via push_event

#### Key Features Implemented

- ✅ Cookie module with JSON serialization
- ✅ Three-tier storage (assigns/session/cookie)
- ✅ Phoenix Plug integration
- ✅ LiveView Hook integration
- ✅ Automatic consent loading
- ✅ Modal visibility logic
- ✅ All existing tests passing (58 tests)
- ✅ Code formatted and linted

#### Technical Decisions

**Database Sync - Deferred to Phase 3.1:**
- ConsentSettings resource doesn't have user relationship by default
- Apps can add user relationship as needed
- Database query functions stubbed with TODO comments
- Focus on cookie/session storage first (works for all users)

**Storage Hierarchy Benefits:**
- Assigns: Fastest access, no serialization
- Session: Server-side cache, no DB roundtrip
- Cookie: Client-side persistence
- Database: Audit trail (when implemented)

#### Compilation & Testing

```bash
mix compile
# Compiling 9 files (.ex)
# Generated ash_cookie_consent app

mix test
# ..........................................................
# Finished in 0.2 seconds (0.2s async, 0.00s sync)
# 58 tests, 0 failures
```

#### Documentation Updates

- Updated README with Plug integration examples
- Updated README with LiveView Hook examples
- Added detailed storage system explanation
- Updated implementation status (Phase 3 in progress)
- Documented data flow through storage tiers

#### Files Modified

- README.md - Integration documentation
- All new modules properly documented with @moduledoc and @doc

#### Status Summary

**Completed:**
- ✅ Cookie management (encoding, decoding, setting, getting)
- ✅ Storage module (three-tier hierarchy)
- ✅ Phoenix Plug (loads consent, sets assigns)
- ✅ LiveView Hook (on_mount, event handlers)
- ✅ README updated with integration examples
- ✅ All tests passing

**Deferred to Phase 3.1:**
- ⏳ Database synchronization for authenticated users
- ⏳ User relationship in ConsentSettings
- ⏳ Form submission handlers
- ⏳ Integration tests for Plug/Hook
- ⏳ Example application

#### Next Steps

**Phase 3.1: Database Sync & Form Handlers**
- Add user relationship support to ConsentSettings
- Implement database query/save functions
- Create form submission handlers
- Write integration tests
- Build example Phoenix application

---

**Phase 3 Core Status: ✅ PARTIALLY COMPLETE**

Cookie/Session storage fully functional. Database sync deferred to Phase 3.1.

